<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© (Tadawul Simulator)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Ø£Ù†Ù…Ø§Ø· CSS: Ø«ÙŠÙ… Ø¯Ø§ÙƒÙ† Ø§Ø­ØªØ±Ø§ÙÙŠ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨ */
        :root {
            --dark-bg: #1e1e2d;
            --main-bg: #282a36;
            --card-bg: #32354a;
            --text-color: #f8f8f2;
            --accent-color: #50fa7b; /* Ø£Ø®Ø¶Ø± Ù„Ù„Ø±Ø¨Ø­ */
            --danger-color: #ff5555; /* Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø³Ø§Ø±Ø© */
            --primary-color: #8be9fd;
            --secondary-color: #bd93f9;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            direction: rtl; /* Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
            transition: all 0.3s ease;
        }

        body.en {
            direction: ltr;
        }

        .container {
            display: flex;
            gap: 15px;
            padding: 15px;
            max-width: 1500px;
            margin: 0 auto;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
        .news-ticker-container {
            overflow: hidden;
            background-color: var(--card-bg);
            padding: 5px 0;
            white-space: nowrap;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .news-ticker {
            display: inline-block;
            animation: ticker-move 30s linear infinite;
        }

        .news-item {
            display: inline-block;
            padding: 0 15px;
            font-size: 0.9em;
        }

        .news-item.up { color: var(--accent-color); }
        .news-item.down { color: var(--danger-color); }

        @keyframes ticker-move {
            0% { transform: translate(100%, 0); }
            100% { transform: translate(-100%, 0); }
        }

        /* Ù…ÙƒÙˆÙ†Ø§Øª Ø¹Ø§Ù…Ø© (Ù„ÙˆØ­Ø©/Ø¨Ø·Ø§Ù‚Ø©) */
        .panel {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #stockChart {
                /* ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ù„Ù„Ù€ canvas Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø© */
                max-height: 400px;
        }

        h2 {
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 8px;
            margin-top: 0;
            font-size: 1.2em;
        }

        /* Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }

        .data-table th {
            background-color: rgba(0, 0, 0, 0.1);
            font-weight: bold;
            color: var(--primary-color);
        }

        .data-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .price-up { color: var(--accent-color); }
        .price-down { color: var(--danger-color); }
        .text-neutral { color: var(--text-color); }
        .text-positive { color: var(--accent-color); }
        .text-negative { color: var(--danger-color); }

        /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ÙˆØ§Ù…Ø± */
        .order-form input, .order-form select, .order-form button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            background-color: var(--main-bg);
            color: var(--text-color);
            box-sizing: border-box;
        }

        .order-form button {
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .btn-buy { background-color: var(--accent-color); color: var(--dark-bg); }
        .btn-buy:hover { background-color: #69ff91; }
        .btn-sell { background-color: var(--danger-color); color: var(--text-color); }
        .btn-sell:hover { background-color: #ff7777; }

        /* Ø§Ù„Ù…Ø­ÙØ¸Ø© */
        .portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
        }

        .portfolio-stock-item {
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 4px;
        }

        .portfolio-stock-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .portfolio-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .portfolio-actions button {
            flex-grow: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        /* Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª ÙˆØ§Ù„ØªØ­ÙƒÙ… */
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .control-group button {
            flex-grow: 1;
            padding: 10px;
            background-color: var(--secondary-color);
            color: var(--dark-bg);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .control-group button:hover {
            background-color: #c9abfb;
        }

        /* ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© */
        .footer {
            text-align: center;
            padding: 10px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 20px;
        }

        /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="news-ticker-container">
        <div class="news-ticker" id="news-ticker">
            </div>
    </div>

    <div class="container">
        <div class="sidebar">

            <div class="panel">
                <div class="control-group">
                    <button id="lang-toggle-btn" onclick="toggleLanguage()">English / Ø¹Ø±Ø¨ÙŠ</button>
                    <button onclick="changeSpeed(1)" data-speed="1">1x</button>
                    <button onclick="changeSpeed(5)" data-speed="5">5x</button>
                    <button onclick="changeSpeed(10)" data-speed="10">10x</button>
                </div>
                <p id="time-speed-indicator">Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©: 1x</p>
            </div>

            <div class="panel" id="portfolio-panel">
                <h2>ğŸ’° Ø§Ù„Ù…Ø­ÙØ¸Ø©</h2>
                <div class="portfolio-header">
                    <span id="cash-balance">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ: 50,000.00 Ø±ÙŠØ§Ù„</span>
                    <span id="total-pl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­/Ø§Ù„Ø®Ø³Ø§Ø¦Ø±: 0.00 Ø±ÙŠØ§Ù„</span>
                </div>
                <div id="portfolio-list">
                    </div>
            </div>

            <div class="panel">
                <h2 id="order-title">Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±</h2>
                <form id="order-form" class="order-form">
                    <select id="order-stock" required onchange="updateOrderTitle(this.value)">
                        <option value="">Ø§Ø®ØªØ± Ø³Ù‡Ù…</option>
                        </select>

                    <select id="order-type" onchange="toggleLimitPrice()">
                        <option value="market">Ø£Ù…Ø± Ø³ÙˆÙ‚ (Market)</option>
                        <option value="limit">Ø£Ù…Ø± Ù…Ø­Ø¯Ø¯ (Limit)</option>
                    </select>

                    <input type="number" id="order-quantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© (Ø³Ù‡Ù…)" min="1" required>

                    <input type="number" id="limit-price" placeholder="Ø³Ø¹Ø± Ù…Ø­Ø¯Ø¯ (Limit Price)" step="0.01" style="display:none;">

                    <button type="button" class="btn-buy" onclick="submitOrder('buy')">Ø´Ø±Ø§Ø¡</button>
                    <button type="button" class="btn-sell" onclick="submitOrder('sell')">Ø¨ÙŠØ¹</button>

                    <p id="order-status-msg" style="margin-top: 10px;"></p>
                </form>
            </div>

            <div class="panel">
                <h2>ğŸ† Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</h2>
                <ul id="challenges-list">
                    </ul>
            </div>

        </div>

        <div class="main-content">

            <div class="panel">
                <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙˆÙ‚ (Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ - ØªØ¯Ø§ÙˆÙ„)</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø³Ù‡Ù…</th>
                            <th>Ø§Ù„Ø±Ù…Ø²</th>
                            <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„ØªØºÙŠØ± (%)</th>
                            <th>Ø§Ù„Ø­Ø¬Ù… (Ø§Ù„Ù€24 Ø³Ø§Ø¹Ø©)</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="stock-market-body">
                        </tbody>
                </table>
            </div>

            <div class="panel">
                <h2 id="chart-title">ğŸ“ˆ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ø§Ø®ØªØ± Ø³Ù‡Ù…)</h2>
                <canvas id="stockChart"></canvas>
            </div>

            <div class="panel">
                <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø³Ù‡Ù…</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                            <th>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="trade-log-body">
                        </tbody>
                </table>
            </div>

            <div class="panel">
                <h2>â³ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Limit)</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø³Ù‡Ù…</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</th>
                            <th>Ø¥Ù„ØºØ§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="pending-orders-body">
                        </tbody>
                </table>
            </div>

        </div>
    </div>

    <div class="footer">
        ØªØ·ÙˆÙŠØ±: Ø¹Ø¨Ø¯Ø§Ù„ÙƒØ±ÙŠÙ… Ø§Ù„Ø¹Ø¨ÙˆØ¯ | abo.saleh.g@gmail.com
        Â© 2024 ImageMetrics Tool - All Rights Reserved
    </div>

    <script>
        // Ù…Ù„Ù JavaScript Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠØ¨Ø¯Ø£ Ù‡Ù†Ø§

        // =================================================================
        // ğŸ’¾ Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
        // =================================================================

        const STOCKS = [
            { symbol: '1010', name: 'Ø§Ù„Ø±ÙŠØ§Ø¶', nameEn: 'Al-Riyadh', sector: 'banks', basePrice: 38.2, mu: 0.0001, sigma: 0.012 },
            { symbol: '2222', name: 'Ø£Ø±Ø§Ù…ÙƒÙˆ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', nameEn: 'Saudi Aramco', sector: 'energy', basePrice: 33.6, mu: 0.0001, sigma: 0.011 },
            { symbol: '7010', name: 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', nameEn: 'STC', sector: 'telecom', basePrice: 44.7, mu: 0.0001, sigma: 0.013 },
            { symbol: '1211', name: 'Ù…Ø¹Ø§Ø¯Ù†', nameEn: 'Ma\'aden', sector: 'materials', basePrice: 67.4, mu: 0.0001, sigma: 0.015 },
            { symbol: '3010', name: 'Ø£Ø³Ù…Ù†Øª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', nameEn: 'Saudi Cement', sector: 'cement', basePrice: 54.8, mu: 0.0001, sigma: 0.014 },
        ];

        const SECTOR_CORRELATION = {
            'banks': { 'energy': 0.3, 'telecom': 0.5, 'materials': 0.2, 'cement': 0.4 },
            'energy': { 'banks': 0.3, 'telecom': 0.1, 'materials': 0.6, 'cement': 0.2 },
            // ... ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ù‡Ù†Ø§
        };

        const COMMISSION_RATE = 0.00155; // 0.155%
        const SLIPPAGE = 0.002; // Â±0.2% Ù„Ù„Ø§Ù†Ø²Ù„Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±ÙŠ ÙÙŠ Ø£Ù…Ø± Ø§Ù„Ø³ÙˆÙ‚

        // =================================================================
        // âš™ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ÙˆØ®Ø·Ø§ÙØ§Øª DOM
        // =================================================================

        let gameState = loadGameState();
        let marketInterval;
        let simulationSpeed = 1;
        let currentChartSymbol = STOCKS[0].symbol;
        let chartInstance;
        let isArabic = true;

        // Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const DOM = {
            cashBalance: document.getElementById('cash-balance'),
            totalPL: document.getElementById('total-pl'),
            portfolioList: document.getElementById('portfolio-list'),
            stockMarketBody: document.getElementById('stock-market-body'),
            tradeLogBody: document.getElementById('trade-log-body'),
            orderStock: document.getElementById('order-stock'),
            orderType: document.getElementById('order-type'),
            limitPrice: document.getElementById('limit-price'),
            newsTicker: document.getElementById('news-ticker'),
            chartTitle: document.getElementById('chart-title'),
            pendingOrdersBody: document.getElementById('pending-orders-body'),
            challengesList: document.getElementById('challenges-list'),
            orderStatusMsg: document.getElementById('order-status-msg'),
            timeSpeedIndicator: document.getElementById('time-speed-indicator'),
        };

        const TEXT = {
            ar: {
                cash: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ', totalPL: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­/Ø§Ù„Ø®Ø³Ø§Ø¦Ø±', marketPanel: 'Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙˆÙ‚ (Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ - ØªØ¯Ø§ÙˆÙ„)',
                orderWindow: 'Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±', selectStock: 'Ø§Ø®ØªØ± Ø³Ù‡Ù…', marketOrder: 'Ø£Ù…Ø± Ø³ÙˆÙ‚ (Market)', limitOrder: 'Ø£Ù…Ø± Ù…Ø­Ø¯Ø¯ (Limit)',
                quantity: 'Ø§Ù„ÙƒÙ…ÙŠØ© (Ø³Ù‡Ù…)', limitPricePlaceholder: 'Ø³Ø¹Ø± Ù…Ø­Ø¯Ø¯ (Limit Price)', buy: 'Ø´Ø±Ø§Ø¡', sell: 'Ø¨ÙŠØ¹',
                stock: 'Ø§Ù„Ø³Ù‡Ù…', symbol: 'Ø§Ù„Ø±Ù…Ø²', currentPrice: 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ', change: 'Ø§Ù„ØªØºÙŠØ± (%)', volume: 'Ø§Ù„Ø­Ø¬Ù…', action: 'Ø¥Ø¬Ø±Ø§Ø¡',
                chart: 'Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ', log: 'Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª', date: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', type: 'Ø§Ù„Ù†ÙˆØ¹', commission: 'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©',
                pnl: 'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©', pendingOrders: 'Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Limit)', cancel: 'Ø¥Ù„ØºØ§Ø¡',
                portfolio: 'Ø§Ù„Ù…Ø­ÙØ¸Ø©', lastPrice: 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø®ÙŠØ±', avgCost: 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©', marketValue: 'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©',
                totalCost: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©', valueAfterSale: 'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹', avgAfterSale: 'Ù…ØªÙˆØ³Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹',
                speed: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', challenges: 'Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª',
                orderTitle: (name) => `Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±: ${name}`,
            },
            en: {
                cash: 'Cash Balance', totalPL: 'Total P&L', marketPanel: 'Market Dashboard (Tadawul)',
                orderWindow: 'Order Window', selectStock: 'Select Stock', marketOrder: 'Market Order', limitOrder: 'Limit Order',
                quantity: 'Quantity (Shares)', limitPricePlaceholder: 'Limit Price', buy: 'Buy', sell: 'Sell',
                stock: 'Stock', symbol: 'Symbol', currentPrice: 'Current Price', change: 'Change (%)', volume: 'Volume', action: 'Action',
                chart: 'Chart', log: 'Trade Log', date: 'Date', type: 'Type', commission: 'Commission',
                pnl: 'P&L', pendingOrders: 'Pending Orders (Limit)', cancel: 'Cancel',
                portfolio: 'Portfolio', lastPrice: 'Last Price', avgCost: 'Average Cost', marketValue: 'Market Value',
                totalCost: 'Total Cost', valueAfterSale: 'Value After Sale', avgAfterSale: 'Average After Sale',
                speed: 'Simulation Speed', challenges: 'Challenges',
                orderTitle: (name) => `Order Window: ${name}`,
            }
        };

        // =================================================================
        // ğŸ’¾ ÙˆØ¸Ø§Ø¦Ù Ø­ÙØ¸ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©
        // =================================================================

        function loadGameState() {
            const savedState = localStorage.getItem('tradingSimulatorState');
            if (savedState) {
                const state = JSON.parse(savedState);
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø£Ø­Ø¯Ø« Ù‚Ø§Ø¦Ù…Ø©
                const marketData = {};
                for (const stock of STOCKS) {
                    marketData[stock.symbol] = state.marketData[stock.symbol] || {
                        price: stock.basePrice,
                        basePrice: stock.basePrice,
                        history: [{ price: stock.basePrice, date: Date.now() }],
                        volume: 0,
                    };
                    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                    marketData[stock.symbol].basePrice = stock.basePrice;
                    marketData[stock.symbol].name = stock.name;
                    marketData[stock.symbol].nameEn = stock.nameEn;
                }
                state.marketData = marketData;
                return state;
            }

            // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const marketData = {};
            for (const stock of STOCKS) {
                marketData[stock.symbol] = {
                    price: stock.basePrice,
                    basePrice: stock.basePrice,
                    history: [{ price: stock.basePrice, date: Date.now() }],
                    volume: 0,
                    name: stock.name,
                    nameEn: stock.nameEn,
                };
            }

            return {
                cash: 50000,
                initialCash: 50000,
                portfolio: {}, // {symbol: {quantity: N, avgCost: C}}
                marketData: marketData,
                tradeLog: [],
                pendingOrders: [],
                totalPnl: 0,
                lastUpdate: Date.now(),
                challenges: [
                    { id: 1, desc_ar: 'Ø­Ù‚Ù‚ 10Ùª Ø±Ø¨Ø­ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ù‹Ø§ (30 ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³Ø¹Ø±) - Ø¯Ø¹Ù… 100,000 Ø±ÙŠØ§Ù„.', desc_en: 'Achieve 10% profit in 30 days (30 price updates) - 100,000 SAR bonus.', targetPnl: 0.1, durationUpdates: 30, bonus: 100000, completed: false, startUpdate: 0 },
                    { id: 2, desc_ar: 'Ø­Ù‚Ù‚ 20Ùª Ø±Ø¨Ø­ Ø¥Ø¬Ù…Ø§Ù„ÙŠ - Ø¯Ø¹Ù… 300,000 Ø±ÙŠØ§Ù„.', desc_en: 'Achieve 20% total profit - 300,000 SAR bonus.', targetPnl: 0.2, bonus: 300000, completed: false },
                ],
                updateCount: 0, // Ù„Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ­Ø¯ÙŠ
                isArabic: true, // Ù„ØºØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            };
        }

        function saveGameState() {
            localStorage.setItem('tradingSimulatorState', JSON.stringify(gameState));
        }

        // =================================================================
        // ğŸ“ˆ Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©: Geometric Brownian Motion (GBM)
        // =================================================================

        /**
         * ÙŠÙˆÙ„Ø¯ Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙŠØªØ¨Ø¹ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ (Box-Muller transform)
         * @returns {number} Z ~ N(0, 1)
         */
        function randn_bm() {
            let u = 0, v = 0;
            while (u === 0) u = Math.random(); // Ù„ØªØ¬Ù†Ø¨ log(0)
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        /**
         * ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£Ø³Ù‡Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Geometric Brownian Motion
         * @param {number} symbol - Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…
         * @param {number} dt - Ø§Ù„ØªØºÙŠØ± Ø§Ù„Ø²Ù…Ù†ÙŠ (Ù†Ø­Ù† Ù†Ø³ØªØ®Ø¯Ù… 1 Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø­Ø¯)
         * @param {number} sectorShock - ØµØ¯Ù…Ø© Ø§Ù„Ù‚Ø·Ø§Ø¹
         * @returns {number} Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
         */
        function updateStockPrice(symbol, dt = 1) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            const data = gameState.marketData[symbol];
            if (!stock || !data) return data.price;

            const mu = stock.mu;
            const sigma = stock.sigma;
            const shock = getSectorShock(stock.sector);

            // GBM Formula: S_t = S_{t-1} * exp((mu - 0.5 * sigma^2) * dt + sigma * W_t)
            // W_t = randn_bm() * sqrt(dt)
            const W_t = randn_bm() * Math.sqrt(dt);
            const drift = (mu - 0.5 * sigma * sigma) * dt;
            const volatility = sigma * W_t;
            const price = data.price * Math.exp(drift + volatility + shock);

            // Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ù„Ø¨
            data.price = Math.max(0.01, parseFloat(price.toFixed(2)));
            
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªØ§Ø±ÙŠØ®
            data.history.push({ price: data.price, date: Date.now() });
            // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ù…Ø­Ø¯ÙˆØ¯ Ù„Ù„ØªØ§Ø±ÙŠØ® (Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ)
            if (data.history.length > 100) {
                data.history.shift();
            }

            return data.price;
        }

        /**
         * ØªÙˆÙ„ÙŠØ¯ ØµØ¯Ù…Ø© Ù‚Ø·Ø§Ø¹ÙŠØ© (Shock)
         * @param {string} sector - Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø³Ù‡Ù…
         * @returns {number} Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ¯Ù…Ø©
         */
        function getSectorShock(sector) {
            // ØµØ¯Ù…Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù†Ø§Ø¯Ø±Ø© (Ø­Ø¯Ø« Ø£Ø®Ø¨Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ)
            if (Math.random() < 0.005) { // 0.5% ÙØ±ØµØ© Ù„Ø­Ø¯ÙˆØ« ØµØ¯Ù…Ø© ÙƒØ¨ÙŠØ±Ø©
                const shockValue = randn_bm() * 0.05; // ØµØ¯Ù…Ø© Ø¨Ù†Ø³Ø¨Ø© ØªØµÙ„ Ø¥Ù„Ù‰ 5%
                const newsMsg = shockValue > 0 ? `Ø®Ø¨Ø± Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ù…ÙØ§Ø¬Ø¦ ÙÙŠ Ù‚Ø·Ø§Ø¹ ${isArabic ? sector : sector.toUpperCase()}!` : `Ø®Ø¨Ø± Ø³Ù„Ø¨ÙŠ Ù…ÙØ§Ø¬Ø¦ ÙÙŠ Ù‚Ø·Ø§Ø¹ ${isArabic ? sector : sector.toUpperCase()}!`;
                logNews(newsMsg, shockValue > 0 ? 'up' : 'down');
                return shockValue;
            }

            // Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ù‚Ø·Ø§Ø¹ÙŠ (Ù„Ù„ØªØ´Ø§Ø¨Ù‡ ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ©)
            let totalShock = 0;
            const sectorData = STOCKS.filter(s => s.sector === sector);
            if (sectorData.length > 1) {
                // Ù†Ø£Ø®Ø° Ø­Ø±ÙƒØ© Ø³Ù‡Ù… ÙˆØ§Ø­Ø¯ ÙƒÙ…ØªÙˆØ³Ø· ØªØ£Ø«ÙŠØ± Ù‚Ø·Ø§Ø¹ÙŠ (Ù„Ù„Ø¨Ø³Ø§Ø·Ø©)
                const referenceStock = sectorData[0];
                const refData = gameState.marketData[referenceStock.symbol];
                if (refData.history.length > 1) {
                    const lastPrice = refData.history[refData.history.length - 1].price;
                    const prevPrice = refData.history[refData.history.length - 2].price;
                    const movement = (lastPrice - prevPrice) / prevPrice; // Ø§Ù„ØªØºÙŠØ± Ø§Ù„Ù†Ø³Ø¨ÙŠ
                    totalShock = movement * 0.5; // ØªØ£Ø«ÙŠØ± Ø¬Ø²Ø¦ÙŠ Ù…Ù† Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ
                }
            }

            return totalShock;
        }

        /**
         * Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙˆÙ‚
         */
        function marketUpdateLoop() {
            gameState.updateCount++;
            for (const stock of STOCKS) {
                updateStockPrice(stock.symbol);
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬Ù… Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ø¹Ø¨Ø© (Ù„Ø£Ù†Ù‡ Ù„ÙŠØ³ Ø¬Ø²Ø¡Ù‹Ø§ Ù…Ù† GBM)
                gameState.marketData[stock.symbol].volume = Math.floor(Math.random() * 5000000 + 100000);
            }

            checkPendingOrders();
            checkChallenges();
            updateAllDisplays();
            saveGameState();
        }

        // =================================================================
        // ğŸ”¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø±
        // =================================================================

        /**
         * ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø¨ÙŠØ¹
         * @param {string} type - 'buy' Ø£Ùˆ 'sell'
         */
        function submitOrder(type) {
            const symbol = DOM.orderStock.value;
            const orderType = DOM.orderType.value;
            const quantity = parseInt(DOM.orderQuantity.value);
            let limitPrice = parseFloat(DOM.limitPrice.value);

            const stock = STOCKS.find(s => s.symbol === symbol);
            const data = gameState.marketData[symbol];

            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            if (!symbol || isNaN(quantity) || quantity <= 0) {
                showOrderStatus(isArabic ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ù‡Ù… ÙˆÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©.' : 'Please select a stock and enter a valid quantity.', 'error');
                return;
            }

            if (orderType === 'limit' && (isNaN(limitPrice) || limitPrice <= 0)) {
                showOrderStatus(isArabic ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ù…Ø­Ø¯Ø¯ ØµØ­ÙŠØ­.' : 'Please enter a valid limit price.', 'error');
                return;
            }

            const currentPrice = data.price;

            if (orderType === 'market') {
                // ------------------ Ø£Ù…Ø± Ø§Ù„Ø³ÙˆÙ‚ ------------------
                const executionPrice = currentPrice * (1 + (type === 'buy' ? SLIPPAGE : -SLIPPAGE) * (Math.random() * 2 - 1));
                executeTrade(symbol, type, quantity, parseFloat(executionPrice.toFixed(2)));
            } else if (orderType === 'limit') {
                // ------------------ Ø£Ù…Ø± Ù…Ø­Ø¯Ø¯ ------------------
                if (type === 'buy' && limitPrice >= currentPrice) {
                    showOrderStatus(isArabic ? 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø£Ù‚Ù„ Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙÙˆØ±ÙŠ.' : 'Buy limit price must be below market price to avoid immediate execution.', 'error');
                    return;
                }
                if (type === 'sell' && limitPrice <= currentPrice) {
                    showOrderStatus(isArabic ? 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙÙˆØ±ÙŠ.' : 'Sell limit price must be above market price to avoid immediate execution.', 'error');
                    return;
                }

                if (type === 'sell' && (!gameState.portfolio[symbol] || gameState.portfolio[symbol].quantity < quantity)) {
                    showOrderStatus(isArabic ? 'ÙƒÙ…ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ© ÙÙŠ Ù…Ø­ÙØ¸ØªÙƒ.' : 'Sell quantity exceeds shares owned in your portfolio.', 'error');
                    return;
                }

                gameState.pendingOrders.push({
                    id: Date.now() + Math.random(),
                    symbol: symbol,
                    type: type,
                    quantity: quantity,
                    limitPrice: limitPrice,
                    date: new Date().toISOString(),
                });
                showOrderStatus(isArabic ? `ØªÙ… ÙˆØ¶Ø¹ Ø£Ù…Ø± ${type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'} Ù…Ø­Ø¯Ø¯ Ù„Ù€ ${quantity} Ø³Ù‡Ù… Ù…Ù† ${isArabic ? stock.name : stock.nameEn} Ø¹Ù†Ø¯ ${limitPrice.toFixed(2)}` : `${quantity} limit ${type} order for ${isArabic ? stock.name : stock.nameEn} at ${limitPrice.toFixed(2)} placed.`, 'info');
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
            updateAllDisplays();
            saveGameState();
            DOM.orderQuantity.value = ''; // Ù…Ø³Ø­ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            DOM.limitPrice.value = '';
        }

        /**
         * ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø¨ÙŠØ¹
         * @param {string} symbol - Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…
         * @param {string} type - 'buy' Ø£Ùˆ 'sell'
         * @param {number} quantity - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…
         * @param {number} price - Ø³Ø¹Ø± Ø§Ù„ØªÙ†ÙÙŠØ°
         * @returns {boolean} - Ù‡Ù„ ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­ØŸ
         */
        function executeTrade(symbol, type, quantity, price) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            const commission = quantity * price * COMMISSION_RATE;
            let logEntry = {
                symbol: symbol,
                type: type,
                quantity: quantity,
                price: price,
                commission: parseFloat(commission.toFixed(2)),
                date: new Date().toISOString(),
                pnl: 0, // Ù„Ù„Ø¨ÙŠØ¹ ÙÙ‚Ø·
            };

            if (type === 'buy') {
                const totalCost = quantity * price + commission;
                if (gameState.cash < totalCost) {
                    showOrderStatus(isArabic ? 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ ØºÙŠØ± ÙƒØ§ÙÙ Ù„ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡.' : 'Insufficient cash balance to execute buy order.', 'error');
                    return false;
                }

                gameState.cash -= totalCost;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙØ¸Ø©
                if (!gameState.portfolio[symbol]) {
                    gameState.portfolio[symbol] = { quantity: 0, avgCost: 0 };
                }
                
                const currentQuantity = gameState.portfolio[symbol].quantity;
                const currentTotalCost = currentQuantity * gameState.portfolio[symbol].avgCost;
                
                gameState.portfolio[symbol].quantity += quantity;
                gameState.portfolio[symbol].avgCost = (currentTotalCost + (quantity * price)) / gameState.portfolio[symbol].quantity;

                showOrderStatus(isArabic ? `Ø´Ø±Ø§Ø¡ ${quantity} Ø³Ù‡Ù… Ù…Ù† ${isArabic ? stock.name : stock.nameEn} Ø¹Ù†Ø¯ ${price.toFixed(2)}` : `Bought ${quantity} shares of ${isArabic ? stock.name : stock.nameEn} at ${price.toFixed(2)}`, 'success');

            } else if (type === 'sell') {
                if (!gameState.portfolio[symbol] || gameState.portfolio[symbol].quantity < quantity) {
                    showOrderStatus(isArabic ? 'Ù„Ø§ ØªÙ…Ù„Ùƒ ÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ© Ù„Ø¨ÙŠØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£Ø³Ù‡Ù….' : 'You do not own enough shares to sell this quantity.', 'error');
                    return false;
                }

                const totalSaleValue = quantity * price - commission;
                gameState.cash += totalSaleValue;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙØ¸Ø©
                const avgCost = gameState.portfolio[symbol].avgCost;
                const costOfSoldShares = quantity * avgCost;
                const realizedPnl = totalSaleValue - costOfSoldShares;
                gameState.totalPnl += realizedPnl;
                logEntry.pnl = parseFloat(realizedPnl.toFixed(2));

                gameState.portfolio[symbol].quantity -= quantity;
                if (gameState.portfolio[symbol].quantity === 0) {
                    delete gameState.portfolio[symbol]; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ù‡Ù… Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒÙ…ÙŠØ© ØµÙØ±
                }

                showOrderStatus(isArabic ? `Ø¨ÙŠØ¹ ${quantity} Ø³Ù‡Ù… Ù…Ù† ${isArabic ? stock.name : stock.nameEn} Ø¹Ù†Ø¯ ${price.toFixed(2)} - Ø±Ø¨Ø­: ${logEntry.pnl.toFixed(2)}` : `Sold ${quantity} shares of ${isArabic ? stock.name : stock.nameEn} at ${price.toFixed(2)} - P&L: ${logEntry.pnl.toFixed(2)}`, realizedPnl >= 0 ? 'success' : 'error');
            }

            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            gameState.tradeLog.unshift(logEntry); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
            return true;
        }

        /**
         * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙˆØªÙ†ÙÙŠØ°Ù‡Ø§
         */
        function checkPendingOrders() {
            const executedOrders = [];
            const newPendingOrders = [];

            for (const order of gameState.pendingOrders) {
                const currentPrice = gameState.marketData[order.symbol].price;
                let executed = false;

                if (order.type === 'buy' && currentPrice <= order.limitPrice) {
                    // Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ ÙŠÙÙ†ÙØ° Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ <= Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
                    executed = executeTrade(order.symbol, order.type, order.quantity, order.limitPrice);
                } else if (order.type === 'sell' && currentPrice >= order.limitPrice) {
                    // Ø£Ù…Ø± Ø¨ÙŠØ¹ ÙŠÙÙ†ÙØ° Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ >= Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
                    // ØªØ­Ù‚Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°
                    const canSell = gameState.portfolio[order.symbol] && gameState.portfolio[order.symbol].quantity >= order.quantity;
                    if (canSell) {
                        executed = executeTrade(order.symbol, order.type, order.quantity, order.limitPrice);
                    } else {
                        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ù…Ø± Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹ (Ù…Ø«Ù„Ø§Ù‹ ØªÙ… Ø¨ÙŠØ¹Ù‡Ø§ Ø¨Ø£Ù…Ø± Ø¢Ø®Ø±)
                        executed = false;
                        showOrderStatus(isArabic ? `ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø£Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù€ ${order.symbol} Ù„Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„ÙƒÙ…ÙŠØ©.` : `Limit sell order for ${order.symbol} cancelled due to insufficient quantity.`, 'error');
                    }
                }

                if (executed) {
                    executedOrders.push(order.id);
                } else {
                    newPendingOrders.push(order);
                }
            }
            gameState.pendingOrders = newPendingOrders;
        }

        /**
         * Ø¥Ù„ØºØ§Ø¡ Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚
         * @param {number} orderId - Ù…ÙØ¹Ø±Ù‘Ù Ø§Ù„Ø£Ù…Ø±
         */
        function cancelPendingOrder(orderId) {
            const initialLength = gameState.pendingOrders.length;
            gameState.pendingOrders = gameState.pendingOrders.filter(order => order.id !== orderId);
            if (gameState.pendingOrders.length < initialLength) {
                showOrderStatus(isArabic ? 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ù…Ø± Ø¨Ù†Ø¬Ø§Ø­.' : 'Order cancelled successfully.', 'info');
                updateAllDisplays();
                saveGameState();
            }
        }

        // =================================================================
        // ğŸ† Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª
        // =================================================================

        function checkChallenges() {
            const initialValue = gameState.initialCash;
            const currentValue = gameState.cash + getTotalMarketValue();
            const totalPnlPercentage = (currentValue - initialValue) / initialValue;

            gameState.challenges.forEach(challenge => {
                if (challenge.completed) return;

                let isCompleted = false;

                if (challenge.targetPnl !== undefined) {
                    // ØªØ­Ø¯ÙŠ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙƒÙ„ÙŠ
                    if (totalPnlPercentage >= challenge.targetPnl) {
                        isCompleted = true;
                    }
                }

                if (challenge.durationUpdates !== undefined) {
                    // ØªØ­Ø¯ÙŠ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ ÙÙŠ ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ© (30 ÙŠÙˆÙ…/ØªØ­Ø¯ÙŠØ«)
                    if (gameState.updateCount === challenge.startUpdate) {
                        // Ø¨Ø¯Ø§ÙŠØ© ÙØªØ±Ø© Ø§Ù„ØªØ­Ø¯ÙŠ
                        challenge.initialValue = currentValue;
                    }

                    if (gameState.updateCount >= challenge.startUpdate + challenge.durationUpdates) {
                        const periodPnlPercentage = (currentValue - challenge.initialValue) / challenge.initialValue;
                        if (periodPnlPercentage >= challenge.targetPnl) {
                            isCompleted = true;
                        } else {
                            // ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŒ ÙŠÙØ¹Ø§Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯
                            challenge.startUpdate = gameState.updateCount;
                        }
                    }
                }

                if (isCompleted) {
                    gameState.cash += challenge.bonus;
                    gameState.totalPnl += challenge.bonus; // Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¬Ø²Ø¡ Ù…Ù† P&L
                    challenge.completed = true;
                    showOrderStatus(isArabic ? `ğŸ† ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ: ${challenge.desc_ar}. ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${challenge.bonus} Ø±ÙŠØ§Ù„.` : `ğŸ† Challenge completed: ${challenge.desc_en}. ${challenge.bonus} SAR added.`, 'success');
                    saveGameState();
                }
            });
        }

        // =================================================================
        // ğŸ–¥ï¸ ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (DOM)
        // =================================================================

        /**
         * ÙŠØ­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø­ÙØ¸Ø©
         * @returns {number} Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©
         */
        function getTotalMarketValue() {
            let totalValue = 0;
            for (const symbol in gameState.portfolio) {
                const quantity = gameState.portfolio[symbol].quantity;
                const price = gameState.marketData[symbol] ? gameState.marketData[symbol].price : 0;
                totalValue += quantity * price;
            }
            return totalValue;
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©
         */
        function updateFinancialSummary() {
            const totalMarketValue = getTotalMarketValue();
            const realizedPnl = gameState.tradeLog.reduce((sum, log) => sum + log.pnl, 0);

            // P&L Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ = (Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© + Ø§Ù„Ù†Ù‚Ø¯) - Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
            const totalValue = gameState.cash + totalMarketValue;
            const unrealizedPnl = totalValue - gameState.initialCash - realizedPnl; // Ù‡Ø°Ø§ ØªÙ‚Ø±ÙŠØ¨ÙŠ

            // Ù†Ø¹Ø±Ø¶ P&L Ø§Ù„Ù…ÙØ­Ù‚Ù‚ ÙˆØºÙŠØ± Ø§Ù„Ù…ÙØ­Ù‚Ù‚ (Ù„Ù„Ø³Ù‡ÙˆÙ„Ø© Ù†Ø¹ØªØ¨Ø± Ù…Ø¬Ù…ÙˆØ¹Ù‡Ø§ P&L Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ)
            const overallPnl = totalValue - gameState.initialCash;
            const pnlClass = overallPnl >= 0 ? 'text-positive' : 'text-negative';

            DOM.cashBalance.innerHTML = `${isArabic ? TEXT.ar.cash : TEXT.en.cash}: ${gameState.cash.toFixed(2)} Ø±ÙŠØ§Ù„`;
            DOM.totalPL.innerHTML = `${isArabic ? TEXT.ar.totalPL : TEXT.en.totalPL}: <span class="${pnlClass}">${overallPnl.toFixed(2)} Ø±ÙŠØ§Ù„ (${(overallPnl / gameState.initialCash * 100).toFixed(2)}%)</span>`;
        }


        /**
         * ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³ÙˆÙ‚
         */
        function updateMarketTable() {
            let html = '';
            let tickerHtml = '';
            for (const stock of STOCKS) {
                const data = gameState.marketData[stock.symbol];
                const prevPrice = data.history[data.history.length - 2]?.price || stock.basePrice;
                const change = data.price - prevPrice;
                const changePercent = (change / prevPrice) * 100;
                const priceClass = change >= 0 ? 'price-up' : 'price-down';

                // Ø³Ø·Ø± Ø§Ù„Ø³ÙˆÙ‚
                html += `
                    <tr onclick="selectStock('${stock.symbol}')" style="cursor: pointer;">
                        <td>${isArabic ? stock.name : stock.nameEn}</td>
                        <td>${stock.symbol}</td>
                        <td class="${priceClass}">${data.price.toFixed(2)}</td>
                        <td class="${priceClass}">${changePercent.toFixed(2)}%</td>
                        <td>${(data.volume / 1000).toFixed(0)}K</td>
                        <td><button class="btn-buy" onclick="event.stopPropagation(); selectStock('${stock.symbol}'); submitOrderPrompt('${stock.symbol}', 'buy')">${isArabic ? 'Ø´Ø±Ø§Ø¡' : 'Buy'}</button></td>
                    </tr>
                `;
                
                // Ø³Ø·Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ
                tickerHtml += `
                    <span class="news-item ${priceClass === 'price-up' ? 'up' : 'down'}">
                        ${isArabic ? stock.name : stock.nameEn} (${stock.symbol}): ${data.price.toFixed(2)} (${changePercent.toFixed(2)}%)
                    </span>
                `;
            }
            DOM.stockMarketBody.innerHTML = html;
            DOM.newsTicker.innerHTML = tickerHtml;
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
         */
        function updatePortfolio() {
            let html = '';
            const allSymbols = Object.keys(gameState.portfolio).filter(symbol => gameState.portfolio[symbol].quantity > 0);

            if (allSymbols.length === 0) {
                DOM.portfolioList.innerHTML = isArabic ? '<p style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ù…Ù…Ù„ÙˆÙƒØ© Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>' : '<p style="text-align: center;">No shares owned currently.</p>';
                return;
            }

            for (const symbol of allSymbols) {
                const holding = gameState.portfolio[symbol];
                const stock = STOCKS.find(s => s.symbol === symbol);
                const data = gameState.marketData[symbol];
                const lastPrice = data.price;

                const avgCost = holding.avgCost;
                const quantity = holding.quantity;

                const totalCost = avgCost * quantity;
                const marketValue = lastPrice * quantity;
                const unrealizedPnl = marketValue - totalCost;
                const pnlPercent = (unrealizedPnl / totalCost) * 100;
                const pnlClass = unrealizedPnl >= 0 ? 'text-positive' : 'text-negative';

                // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹ (Sale Value): Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© - Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¨ÙŠØ¹
                const valueAfterSale = marketValue * (1 - COMMISSION_RATE);
                
                // Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹: Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹ - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©
                const pnlAfterSale = valueAfterSale - totalCost;
                const pnlAfterSaleClass = pnlAfterSale >= 0 ? 'text-positive' : 'text-negative';

                html += `
                    <div class="portfolio-stock-item">
                        <strong onclick="selectStock('${symbol}')" style="cursor: pointer; display: block; margin-bottom: 5px;">${isArabic ? stock.name : stock.nameEn} (${symbol}) - ${quantity} ${isArabic ? 'Ø³Ù‡Ù…' : 'Shs'}</strong>
                        
                        <div class="portfolio-stock-row">
                            <span>${isArabic ? TEXT.ar.lastPrice : TEXT.en.lastPrice}: ${lastPrice.toFixed(2)}</span>
                            <span>${isArabic ? TEXT.ar.avgCost : TEXT.en.avgCost}: ${avgCost.toFixed(2)}</span>
                            <span>${isArabic ? TEXT.ar.marketValue : TEXT.en.marketValue}: ${marketValue.toFixed(2)}</span>
                        </div>
                        
                        <div class="portfolio-stock-row">
                            <span>${isArabic ? TEXT.ar.totalCost : TEXT.en.totalCost}: ${totalCost.toFixed(2)}</span>
                            <span>${isArabic ? TEXT.ar.valueAfterSale : TEXT.en.valueAfterSale}: ${valueAfterSale.toFixed(2)}</span>
                            <span>${isArabic ? TEXT.ar.pnl : TEXT.en.pnl} (${isArabic ? 'Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹' : 'After Sale'}): <span class="${pnlAfterSaleClass}">${pnlAfterSale.toFixed(2)} (${pnlPercent.toFixed(2)}%)</span></span>
                        </div>

                        <div class="portfolio-actions">
                            <button class="btn-buy" onclick="selectStock('${symbol}'); DOM.orderType.value='market'; toggleLimitPrice(); submitOrderPrompt('${symbol}', 'buy')">${isArabic ? 'Ø´Ø±Ø§Ø¡' : 'Buy'}</button>
                            <button class="btn-sell" onclick="selectStock('${symbol}'); DOM.orderType.value='market'; toggleLimitPrice(); submitOrderPrompt('${symbol}', 'sell')">${isArabic ? 'Ø¨ÙŠØ¹' : 'Sell'}</button>
                        </div>
                    </div>
                `;
            }
            DOM.portfolioList.innerHTML = html;
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª
         */
        function updateTradeLog() {
            let html = '';
            // Ø¹Ø±Ø¶ Ø¢Ø®Ø± 50 ØµÙÙ‚Ø© ÙÙ‚Ø·
            const displayLog = gameState.tradeLog.slice(0, 50);

            for (const log of displayLog) {
                const stock = STOCKS.find(s => s.symbol === log.symbol);
                const typeClass = log.type === 'buy' ? 'text-positive' : 'text-negative';
                const pnlClass = log.pnl >= 0 ? 'text-positive' : 'text-negative';
                const typeText = isArabic ? (log.type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹') : (log.type === 'buy' ? 'Buy' : 'Sell');

                html += `
                    <tr>
                        <td>${new Date(log.date).toLocaleTimeString(isArabic ? 'ar-SA' : 'en-US')}</td>
                        <td>${isArabic ? stock.name : stock.nameEn} (${log.symbol})</td>
                        <td class="${typeClass}">${typeText}</td>
                        <td>${log.quantity}</td>
                        <td>${log.price.toFixed(2)}</td>
                        <td>${log.commission.toFixed(2)}</td>
                        <td class="${pnlClass}">${log.pnl.toFixed(2)}</td>
                    </tr>
                `;
            }
            DOM.tradeLogBody.innerHTML = html;
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
         */
        function updatePendingOrders() {
            let html = '';

            if (gameState.pendingOrders.length === 0) {
                DOM.pendingOrdersBody.innerHTML = isArabic ? `<tr><td colspan="5" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</td></tr>` : `<tr><td colspan="5" style="text-align: center;">No pending orders currently.</td></tr>`;
                return;
            }

            for (const order of gameState.pendingOrders) {
                const stock = STOCKS.find(s => s.symbol === order.symbol);
                const typeClass = order.type === 'buy' ? 'text-positive' : 'text-negative';
                const typeText = isArabic ? (order.type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹') : (order.type === 'buy' ? 'Buy' : 'Sell');

                html += `
                    <tr>
                        <td>${isArabic ? stock.name : stock.nameEn} (${order.symbol})</td>
                        <td class="${typeClass}">${typeText}</td>
                        <td>${order.quantity}</td>
                        <td>${order.limitPrice.toFixed(2)}</td>
                        <td><button class="btn-sell" onclick="cancelPendingOrder(${order.id})">${isArabic ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel'}</button></td>
                    </tr>
                `;
            }
            DOM.pendingOrdersBody.innerHTML = html;
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª
         */
        function updateChallengesList() {
            let html = '';
            gameState.challenges.forEach(challenge => {
                const desc = isArabic ? challenge.desc_ar : challenge.desc_en;
                const status = challenge.completed ? (isArabic ? 'âœ… ØªÙ… Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„' : 'âœ… Completed') : (isArabic ? 'â³ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…' : 'â³ In Progress');
                const statusClass = challenge.completed ? 'text-positive' : 'text-neutral';
                
                html += `
                    <li style="margin-bottom: 5px;">
                        ${desc} - <span class="${statusClass}">${status}</span>
                    </li>
                `;
            });
            DOM.challengesList.innerHTML = html;
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
         */
        function updateAllDisplays() {
            updateFinancialSummary();
            updateMarketTable();
            updatePortfolio();
            updateTradeLog();
            updatePendingOrders();
            updateChallengesList();
            updateChart(currentChartSymbol);
            updateSpeedIndicator();
            updateLanguageDisplay();
        }

        // =================================================================
        // ğŸ“‰ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Chart.js)
        // =================================================================

        /**
         * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
         */
        function initializeChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: varColor('primary-color'),
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear', // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù‚ÙŠØ§Ø³ Ø®Ø·ÙŠ
                            ticks: {
                                callback: function(value, index) {
                                    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒÙ„ 10 Ù†Ù‚Ø§Ø· (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…)
                                    if (index % 10 === 0) {
                                        const date = new Date(value);
                                        return date.toLocaleTimeString(isArabic ? 'ar-SA' : 'en-US');
                                    }
                                    return '';
                                },
                                color: varColor('text-color'),
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            title: { display: true, text: isArabic ? 'Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„)' : 'Price (SAR)', color: varColor('text-color') },
                            ticks: { color: varColor('text-color') },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} SAR`;
                                },
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleTimeString(isArabic ? 'ar-SA' : 'en-US') + ' - ' + date.toLocaleDateString(isArabic ? 'ar-SA' : 'en-US');
                                }
                            }
                        }
                    }
                }
            });
            // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            document.getElementById('stockChart').style.height = '400px';
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ø³Ø¬Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ù„Ø³Ù‡Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯
         * @param {string} symbol - Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…
         */
        function updateChart(symbol) {
            currentChartSymbol = symbol;
            const data = gameState.marketData[symbol];
            const stock = STOCKS.find(s => s.symbol === symbol);
            
            if (!chartInstance || !data || !stock) return;

            DOM.chartTitle.innerHTML = `${isArabic ? TEXT.ar.chart : TEXT.en.chart}: ${isArabic ? stock.name : stock.nameEn} (${symbol})`;

            const chartData = data.history.map(h => ({ x: h.date, y: h.price }));

            chartInstance.data.datasets[0].data = chartData;
            chartInstance.options.scales.y.title.text = isArabic ? 'Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„)' : 'Price (SAR)';

            // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø®Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØºÙŠØ± Ø§Ù„Ø£Ø®ÙŠØ±
            const lastPrice = data.history[data.history.length - 1]?.price;
            const firstPrice = data.history[0]?.price;
            const color = (lastPrice >= firstPrice) ? varColor('accent-color') : varColor('danger-color');
            chartInstance.data.datasets[0].borderColor = color;

            chartInstance.update();
        }

        /**
         * ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ù…ØªØºÙŠØ± CSS
         */
        function varColor(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(`--${varName}`).trim();
        }

        // =================================================================
        // ğŸŒ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù„ØºØ©
        // =================================================================

        /**
         * ØªØ¨Ø¯ÙŠÙ„ Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
         * @param {number} speed - Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (1, 5, 10)
         */
        function changeSpeed(speed) {
            simulationSpeed = speed;
            clearInterval(marketInterval);
            // 60 Ø«Ø§Ù†ÙŠØ© (Ø³Ø§Ø¹Ø© ØªØ¯Ø§ÙˆÙ„) / Ø§Ù„Ø³Ø±Ø¹Ø©
            marketInterval = setInterval(marketUpdateLoop, (60000 / simulationSpeed));
            updateSpeedIndicator();
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø±Ø¹Ø©
         */
        function updateSpeedIndicator() {
            DOM.timeSpeedIndicator.textContent = `${isArabic ? TEXT.ar.speed : TEXT.en.speed}: ${simulationSpeed}x`;
        }

        /**
         * ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø®Ø§Ù†Ø© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
         */
        function toggleLimitPrice() {
            DOM.limitPrice.style.display = DOM.orderType.value === 'limit' ? 'block' : 'none';
        }

        /**
         * Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
         * @param {string} message - Ø§Ù„Ø±Ø³Ø§Ù„Ø©
         * @param {string} type - 'success', 'error', 'info'
         */
        function showOrderStatus(message, type) {
            const msgElement = DOM.orderStatusMsg;
            msgElement.textContent = message;
            msgElement.style.color = type === 'success' ? varColor('accent-color') :
                                     type === 'error' ? varColor('danger-color') :
                                     varColor('primary-color');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
            setTimeout(() => { msgElement.textContent = ''; }, 5000);
        }

        /**
         * ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ
         * @param {string} message - Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠØ©
         * @param {string} type - 'up' Ø£Ùˆ 'down'
         */
        function logNews(message, type) {
            const item = document.createElement('span');
            item.className = `news-item ${type}`;
            item.textContent = message;
            DOM.newsTicker.appendChild(item);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø¨Ø¹Ø¯ ÙØªØ±Ø©)
            setTimeout(() => {
                if (DOM.newsTicker.firstChild === item) {
                    DOM.newsTicker.removeChild(item);
                }
            }, 300000); // Ø¥Ø²Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚
        }

        /**
         * Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù‡Ù… ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
         */
        function populateOrderStockList() {
            let html = `<option value="">${isArabic ? TEXT.ar.selectStock : TEXT.en.selectStock}</option>`;
            STOCKS.forEach(stock => {
                html += `<option value="${stock.symbol}">${isArabic ? stock.name : stock.nameEn} (${stock.symbol})</option>`;
            });
            DOM.orderStock.innerHTML = html;
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
         * @param {string} symbol - Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯
         */
        function updateOrderTitle(symbol) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            const name = stock ? (isArabic ? stock.name : stock.nameEn) : (isArabic ? TEXT.ar.orderWindow : TEXT.en.orderWindow);
            document.getElementById('order-title').textContent = isArabic ? TEXT.ar.orderTitle(name) : TEXT.en.orderTitle(name);
        }

        /**
         * ØªØ­Ø¯ÙŠØ¯ Ø³Ù‡Ù… Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
         * @param {string} symbol - Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…
         */
        function selectStock(symbol) {
            currentChartSymbol = symbol;
            DOM.orderStock.value = symbol;
            updateChart(symbol);
            updateOrderTitle(symbol);
        }

        /**
         * ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¨ÙƒÙ…ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©/Ø§Ù„Ø³ÙˆÙ‚
         */
        function submitOrderPrompt(symbol, type) {
             const data = gameState.marketData[symbol];
             const stock = STOCKS.find(s => s.symbol === symbol);
             const isSell = type === 'sell';
             const price = data.price.toFixed(2);
             
             // Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ù‡Ù… ÙˆØ§Ù„Ù†ÙˆØ¹
             DOM.orderStock.value = symbol;
             DOM.orderType.value = 'market'; // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø³ÙˆÙ‚ Ù…Ù† Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø³Ø±ÙŠØ¹
             toggleLimitPrice();
             updateOrderTitle(symbol);

             // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
             let defaultQuantity = 1;
             if (isSell && gameState.portfolio[symbol]) {
                 defaultQuantity = gameState.portfolio[symbol].quantity;
             }
             DOM.orderQuantity.value = defaultQuantity;
             
             // Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¬ÙŠÙ‡
             showOrderStatus(isArabic ? `Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø£Ù…Ø± ${isSell ? 'Ø§Ù„Ø¨ÙŠØ¹' : 'Ø§Ù„Ø´Ø±Ø§Ø¡'} Ù„Ù€ ${defaultQuantity} Ø³Ù‡Ù… Ø¨Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ (${price})` : `${isSell ? 'Sell' : 'Buy'} market order for ${defaultQuantity} shares at market price (${price}) is ready.`, 'info');
        }

        /**
         * ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©
         */
        function toggleLanguage() {
            isArabic = !isArabic;
            gameState.isArabic = isArabic;
            document.body.dir = isArabic ? 'rtl' : 'ltr';
            document.body.classList.toggle('en', !isArabic);

            // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©
            document.querySelector('#portfolio-panel h2').textContent = isArabic ? TEXT.ar.portfolio : TEXT.en.portfolio;
            document.querySelector('#order-title').textContent = isArabic ? TEXT.ar.orderWindow : TEXT.en.orderWindow;
            document.querySelector('#order-stock option[value=""]').textContent = isArabic ? TEXT.ar.selectStock : TEXT.en.selectStock;
            document.querySelector('#order-type option[value="market"]').textContent = isArabic ? TEXT.ar.marketOrder : TEXT.en.marketOrder;
            document.querySelector('#order-type option[value="limit"]').textContent = isArabic ? TEXT.ar.limitOrder : TEXT.en.limitOrder;
            document.querySelector('#order-quantity').placeholder = isArabic ? TEXT.ar.quantity : TEXT.en.quantity;
            document.querySelector('#limit-price').placeholder = isArabic ? TEXT.ar.limitPricePlaceholder : TEXT.en.limitPricePlaceholder;
            document.querySelector('.btn-buy').textContent = isArabic ? TEXT.ar.buy : TEXT.en.buy;
            document.querySelector('.btn-sell').textContent = isArabic ? TEXT.ar.sell : TEXT.en.sell;
            document.querySelector('#challenges-list').previousElementSibling.textContent = isArabic ? TEXT.ar.challenges : TEXT.en.challenges;
            document.querySelector('.main-content > .panel:nth-child(1) h2').textContent = isArabic ? TEXT.ar.marketPanel : TEXT.en.marketPanel;
            document.querySelector('#trade-log-body').previousElementSibling.previousElementSibling.textContent = isArabic ? TEXT.ar.log : TEXT.en.log;
            document.querySelector('#pending-orders-body').previousElementSibling.previousElementSibling.textContent = isArabic ? TEXT.ar.pendingOrders : TEXT.en.pendingOrders;

            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            const marketHeaders = document.querySelector('#stock-market-body').previousElementSibling.querySelectorAll('th');
            marketHeaders[0].textContent = isArabic ? TEXT.ar.stock : TEXT.en.stock;
            marketHeaders[1].textContent = isArabic ? TEXT.ar.symbol : TEXT.en.symbol;
            marketHeaders[2].textContent = isArabic ? TEXT.ar.currentPrice : TEXT.en.currentPrice;
            marketHeaders[3].textContent = isArabic ? TEXT.ar.change : TEXT.en.change;
            marketHeaders[4].textContent = isArabic ? TEXT.ar.volume : TEXT.en.volume;
            marketHeaders[5].textContent = isArabic ? TEXT.ar.action : TEXT.en.action;

            const logHeaders = document.querySelector('#trade-log-body').previousElementSibling.querySelectorAll('th');
            logHeaders[0].textContent = isArabic ? TEXT.ar.date : TEXT.en.date;
            logHeaders[1].textContent = isArabic ? TEXT.ar.stock : TEXT.en.stock;
            logHeaders[2].textContent = isArabic ? TEXT.ar.type : TEXT.en.type;
            logHeaders[3].textContent = isArabic ? TEXT.ar.quantity : TEXT.en.quantity;
            logHeaders[4].textContent = isArabic ? TEXT.ar.currentPrice : TEXT.en.currentPrice;
            logHeaders[5].textContent = isArabic ? TEXT.ar.commission : TEXT.en.commission;
            logHeaders[6].textContent = isArabic ? TEXT.ar.pnl : TEXT.en.pnl;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            populateOrderStockList();
            updateAllDisplays();
        }

        /**
         * ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
         */
        function updateLanguageDisplay() {
             isArabic = gameState.isArabic;
             document.body.dir = isArabic ? 'rtl' : 'ltr';
             document.body.classList.toggle('en', !isArabic);

             document.getElementById('lang-toggle-btn').textContent = isArabic ? 'English / Ø¹Ø±Ø¨ÙŠ' : 'Ø¹Ø±Ø¨ÙŠ / English';
             
             // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø°ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ© (Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©)
             populateOrderStockList();
             updateOrderTitle(DOM.orderStock.value);
        }

        // =================================================================
        // ğŸš€ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡
        // =================================================================

        function init() {
            // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            isArabic = gameState.isArabic;

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆÙÙ‚Ù‹Ø§ Ù„Ù„Ø­Ø§Ù„Ø©
            updateLanguageDisplay();
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            initializeChart();

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            populateOrderStockList();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ
            updateAllDisplays();
            
            // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            selectStock(STOCKS[0].symbol); 

            // Ø¨Ø¯Ø¡ Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
            changeSpeed(simulationSpeed); 
        }

        window.onload = init;

        // Ø¥ØªØ§Ø­Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ù† HTML
        window.toggleLanguage = toggleLanguage;
        window.changeSpeed = changeSpeed;
        window.toggleLimitPrice = toggleLimitPrice;
        window.submitOrder = submitOrder;
        window.selectStock = selectStock;
        window.cancelPendingOrder = cancelPendingOrder;
        window.updateOrderTitle = updateOrderTitle;
        window.submitOrderPrompt = submitOrderPrompt;
    </script>
</body>
</html>
